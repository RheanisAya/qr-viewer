<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Stvrzenka</title>
    <script src="https://unpkg.com/pdf-lib@1.16.0"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            padding: 20px;
            background-color: #f9f9f9;
            text-align: center;
        }
        #receipt {
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            max-width: 400px;
            margin: auto;
            text-align: left;
        }
        .row {
            display: flex;
            justify-content: space-between;
            border-bottom: 1px solid #ddd;
            padding: 5px 0;
        }
        .label {
            font-weight: bold;
        }
        .separator {
            text-align: center;
            font-weight: bold;
            padding: 5px 0;
        }
        .btn {
            display: inline-block;
            margin: 10px;
            padding: 10px 20px;
            font-size: 16px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .btn:hover {
            background: #0056b3;
        }
    </style>
</head>
<body>

    <h1>QR Stvrzenka</h1>
    <p>Zde se zobrazí text přenesený přes QR kód:</p>
    
    <div id="receipt">(čekám na data...)</div>
    
    <button class="btn" id="savePdfBtn">Uložit jako PDF</button>
    <button class="btn" id="copyBtn">Kopírovat do schránky</button>
    <button class="btn" id="saveTxtBtn">Uložit jako TXT</button>

    <script>
        async function generatePdf() {
            const { PDFDocument, rgb, StandardFonts } = PDFLib;
            const pdfDoc = await PDFDocument.create();
            const page = pdfDoc.addPage([500, 700]);

            const font = await pdfDoc.embedFont(StandardFonts.Helvetica);
            const { width, height } = page.getSize();
            
            let y = height - 50;
            page.drawText("Stvrzenka", { x: 200, y, size: 18, font, color: rgb(0, 0, 0) });
            y -= 30;

            let data = document.getElementById("receipt").innerText.split("\n");
            let lineHeight = 20;

            for (let line of data) {
                if (line.includes("|")) {
                    let [label, value] = line.split("|").map(s => s.trim());
                    page.drawText(label, { x: 50, y, size: 12, font, color: rgb(0, 0, 0) });
                    page.drawText(value, { x: 300, y, size: 12, font, color: rgb(0, 0, 0) });
                } else {
                    page.drawText(line, { x: 200, y, size: 12, font, color: rgb(0, 0, 0) });
                }
                y -= lineHeight;
            }

            const pdfBytes = await pdfDoc.save();
            const blob = new Blob([pdfBytes], { type: "application/pdf" });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "stvrzenka.pdf";
            link.click();
        }

        function getQueryParam(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return decodeURIComponent(urlParams.get(name) || "");
        }

        function parseReceipt(text) {
            const lines = text.split("\n");
            let html = "";
            lines.forEach(line => {
                if (line.includes("|")) {
                    const [label, value] = line.split("|").map(s => s.trim());
                    html += `<div class="row"><span class="label">${label}</span><span>${value}</span></div>`;
                } else {
                    html += `<div class="separator">${line}</div>`;
                }
            });
            return html;
        }

        let data = getQueryParam("data");
        console.log("Získaná data:", data);
        if (data) {
            document.getElementById("receipt").innerHTML = parseReceipt(data);
        } else {
            document.getElementById("receipt").innerHTML = "<i>Žádná data nebyla nalezena.</i>";
        }

        document.getElementById("savePdfBtn").addEventListener("click", generatePdf);

        document.getElementById("copyBtn").addEventListener("click", async function() {
            try {
                let text = document.getElementById("receipt").innerText;
                await navigator.clipboard.writeText(text);
                alert("Text byl zkopírován do schránky!");
            } catch (err) {
                console.error("Kopírování selhalo", err);
                alert("Kopírování do schránky není podporováno.");
            }
        });

        document.getElementById("saveTxtBtn").addEventListener("click", function() {
            let text = document.getElementById("receipt").innerText;
            const textBlob = new Blob([text], { type: "text/plain" });
            const downloadLink = document.createElement("a");
            downloadLink.href = URL.createObjectURL(textBlob);
            downloadLink.download = "stvrzenka.txt";
            downloadLink.click();
        });
    </script>

</body>
</html>
